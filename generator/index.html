<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Macstore Digital · Generator Nomor Pesanan</title>
  <meta name="description" content="Generator nomor pesanan statis untuk GitHub Pages" />
  <style>
    :root { --bg:#0f172a; --card:#111827; --muted:#94a3b8; --text:#e5e7eb; --accent:#22c55e; --accent2:#3b82f6; --danger:#ef4444; }
    *{box-sizing:border-box} body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,'Noto Sans',sans-serif;background:linear-gradient(180deg,#0b1220,#0f172a 40%,#0b1325);color:var(--text);} 
    .container{max-width:900px;margin:40px auto;padding:24px}
    .card{background:rgba(17,24,39,.6);backdrop-filter: blur(8px); border:1px solid rgba(148,163,184,.2);border-radius:16px;padding:20px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    h1{margin:0 0 12px;font-size:28px}
    p{color:var(--muted);margin:6px 0 18px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .field{flex:1;min-width:220px}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    input[type="text"], select{width:100%;padding:12px 14px;border-radius:12px;border:1px solid rgba(148,163,184,.3);background:#0b1220;color:var(--text);outline:none}
    input[type="number"]{width:100%;padding:12px 14px;border-radius:12px;border:1px solid rgba(148,163,184,.3);background:#0b1220;color:var(--text);outline:none}
    .btn{appearance:none;border:1px solid rgba(148,163,184,.3);background:#0b1220;color:var(--text);padding:12px 16px;border-radius:12px;cursor:pointer;transition:transform .02s ease, border-color .2s ease, background .2s ease}
    .btn:hover{border-color:rgba(148,163,184,.6)}
    .btn:active{transform:scale(.98)}
    .btn.primary{background:var(--accent);border-color:transparent;color:#001b0b;font-weight:700}
    .btn.secondary{background:#0b1220}
    .btn.info{background:var(--accent2);border-color:transparent;color:#081225;font-weight:700}
    .btn.danger{background:var(--danger);border-color:transparent;color:#2b0a0a;font-weight:700}
    .output{margin-top:12px;padding:16px;border:1px dashed rgba(148,163,184,.35);border-radius:12px;background:rgba(2,6,23,.6);display:flex;justify-content:space-between;align-items:center;gap:12px}
    .code{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;font-size:20px;letter-spacing:.5px}
    .muted{color:var(--muted)}
    .history{margin-top:18px;max-height:300px;overflow:auto;border:1px solid rgba(148,163,184,.2);border-radius:12px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid rgba(148,163,184,.15);font-size:14px}
    th{position:sticky;top:0;background:#0a101d;text-align:left;color:#cbd5e1}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;background:rgba(56,189,248,.15);border:1px solid rgba(56,189,248,.35);color:#7dd3fc;font-size:12px}
    footer{margin-top:18px;color:var(--muted);font-size:12px}
  .toast{position:fixed;right:18px;bottom:18px;background:rgba(2,6,23,.95);border:1px solid rgba(148,163,184,.25);color:#e5e7eb;padding:10px 14px;border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,.3);font-size:13px;z-index:1000}
  .brand{display:flex;align-items:center;gap:10px;padding:12px 16px;border-bottom:1px solid rgba(148,163,184,.2);background:rgba(10,16,29,.6);backdrop-filter:blur(8px);position:sticky;top:0;z-index:50}
.brand .logo{width:28px;height:28px;border-radius:8px;display:grid;place-items:center;font-weight:800;background:linear-gradient(135deg,var(--accent),var(--accent2));color:#081225;letter-spacing:.5px}
.brand .name{font-weight:700}
.brand .tag{color:var(--muted);font-size:12px}
.watermark{position:fixed;left:18px;bottom:18px;opacity:.08;font-weight:800;font-size:42px;pointer-events:none;user-select:none}
.card{position:relative;overflow:hidden}
.card::after{content:"";position:absolute;inset:-1px;border-radius:16px;padding:1px;background:linear-gradient(135deg,rgba(34,197,94,.35),rgba(59,130,246,.35));-webkit-mask:linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);-webkit-mask-composite:xor;mask-composite:exclude;pointer-events:none}
input:focus,select:focus{border-color:var(--accent2);box-shadow:0 0 0 3px rgba(59,130,246,.15) inset}
.btn.primary:hover{box-shadow:0 0 0 3px rgba(34,197,94,.2) inset}
.btn.info:hover{box-shadow:0 0 0 3px rgba(59,130,246,.2) inset}
.btn.danger:hover{box-shadow:0 0 0 3px rgba(239,68,68,.2) inset}
tbody tr:nth-child(even){background:rgba(148,163,184,.07)}
tbody tr:hover{background:rgba(148,163,184,.12)}
  </style>
</head>
<body>
<header class="brand">
  <div class="logo" aria-hidden="true">MD</div>
  <div>
    <div class="name">Macstore Digital</div>
    <div class="tag">Generator Nomor Pesanan</div>
  </div>
</header>
<div class="watermark">Macstore Digital</div>
  <div class="container">
    <div class="card">
      <h1>Generator Nomor Pesanan</h1>
      <p>Statis. Bisa di-host di GitHub Pages. Unik via <span class="badge">crypto</span> + counter <span class="badge">localStorage</span>.</p>

      <div class="row" aria-label="controls">
        <div class="field">
          <label>Prefix tampilan</label>
          <input id="prefix" type="text" value="No Pesanan: " />
        </div>
        <div class="field">
          <label>Pola ID</label>
          <select id="pattern">
            <option value="D2A8">D2A8 · 2 digit + 8 alfanumerik (contoh: 03DN9K3A7)</option>
            <option value="YYMMDD-R4">YYMMDD-R4 · Tanggal + 4 alfanumerik (contoh: 251017-9K3A)</option>
            <option value="INV-R3R3">INV-R3R3 · INV-XXX-YYY (contoh: INV-9KD-J2A)</option>
          </select>
        </div>
        <div class="field">
          <label>Huruf kapital?</label>
          <select id="uppercase">
            <option value="1" selected>YA</option>
            <option value="0">tidak</option>
          </select>
        </div>
        <div class="field">
          <label>Auto salin setelah generate</label>
          <select id="autocopy">
            <option value="1" selected>YA</option>
            <option value="0">tidak</option>
          </select>
        </div>
      </div>

      <div class="row" style="margin-top:12px">
        <button class="btn primary" id="btnGen">Generate</button>
        <button class="btn secondary" id="btnCopy">Copy</button>
        <button class="btn info" id="btnCsv">Download CSV</button>
        <button class="btn danger" id="btnReset">Reset Counter</button>
      </div>

      <div class="output" role="status" aria-live="polite">
        <div>
          <div class="muted">Preview</div>
          <div class="code" id="preview">No Pesanan: —</div>
        </div>
        <div><span class="badge" id="countBadge">0 dibuat</span></div>
      </div>

      <div class="history">
        <table id="tbl">
          <thead><tr><th style="width:180px">Waktu</th><th>ID</th><th style="width:120px">Urutan</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>

      <footer>
  <div>Properti <strong>Macstore Digital</strong>. Simpan riwayat di perangkat ini. Untuk multi-user, host di GitHub Pages per device.</div>
  <div style="margin-top:6px">© 2025 Macstore Digital · <a href="https://macstoredigital.id" target="_blank" rel="noopener" style="color:#93c5fd">macstoredigital.id</a></div>
</footer>
    </div>
  </div>

<div id="toast" class="toast" aria-live="polite" hidden></div>

<script>
(function(){
  const el = (id)=>document.getElementById(id);
  const prefix = el('prefix');
  const pattern = el('pattern');
  const uppercase = el('uppercase');
  const autocopy = el('autocopy');
  const preview = el('preview');
  const btnGen = el('btnGen');
  const btnCopy = el('btnCopy');
  const btnCsv = el('btnCsv');
  const btnReset = el('btnReset');
  const tbody = document.querySelector('#tbl tbody');
  const badge = el('countBadge');
  const toastEl = document.getElementById('toast');
  const showToast = (m)=>{ if(!toastEl) return; toastEl.textContent=m; toastEl.hidden=false; clearTimeout(showToast.t); showToast.t=setTimeout(()=>toastEl.hidden=true,1200); };

  const LS_COUNTER = 'order_counter_v1';
  const LS_HISTORY = 'order_history_v1';
  const LS_ISSUED  = 'order_issued_v1';

  // RNG fallback: gunakan crypto jika ada, jika tidak gunakan Math.random
  const rng = (arr)=>{
    if (self.crypto && self.crypto.getRandomValues) return self.crypto.getRandomValues(arr);
    for(let i=0;i<arr.length;i++) arr[i] = Math.floor(Math.random()*256);
    return arr;
  };

  const randAlnum = (n)=>{
    // cryptographically-strong random alphanumeric (0-9 A-Z)
    const bytes = new Uint8Array(n*2);
    rng(bytes);
    let out = '';
    for(let i=0;i<bytes.length && out.length<n;i++){
      const v = bytes[i] % 36; // 0..35
      out += v.toString(36);
    }
    return out;
  };

  const randDigits = (n)=>{
    const bytes = new Uint8Array(n);
    rng(bytes);
    let s='';
    for(let i=0;i<n;i++) s += (bytes[i] % 10).toString(10);
    return s;
  };

  const todayYYMMDD = ()=>{
    const d = new Date();
    const yy = String(d.getFullYear()).slice(-2);
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const dd = String(d.getDate()).padStart(2,'0');
    return yy+mm+dd;
  };

  const load = (k,def)=>{
    try{ const v = JSON.parse(localStorage.getItem(k)||''); return v ?? def; }catch{ return def; }
  };
  const save = (k,v)=>localStorage.setItem(k,JSON.stringify(v));

  let counter = load(LS_COUNTER, 0);
  let history = load(LS_HISTORY, []);
  let issued  = new Set(load(LS_ISSUED, []));

  const updateBadge = ()=>{ badge.textContent = `${history.length} dibuat`; };
  const refreshTable = ()=>{
    tbody.innerHTML = '';
    for(const row of history.slice().reverse()){
      const tr = document.createElement('tr');
      const td1 = document.createElement('td');
      const td2 = document.createElement('td');
      const td3 = document.createElement('td');
      td1.textContent = new Date(row.ts).toLocaleString();
      td2.textContent = row.id;
      td3.textContent = row.seq;
      tr.append(td1,td2,td3);
      tbody.appendChild(tr);
    }
    updateBadge();
  };

  const formatByPattern = (pat)=>{
    switch(pat){
      case 'D2A8': return randDigits(2) + randAlnum(8);
      case 'YYMMDD-R4': return todayYYMMDD() + '-' + randAlnum(4);
      case 'INV-R3R3': return 'INV-' + randAlnum(3) + '-' + randAlnum(3);
      default: return randDigits(2) + randAlnum(8);
    }
  };

  const toCase = (s)=> uppercase.value==='1' ? s.toUpperCase() : s.toLowerCase();

  const uniqueId = ()=>{
    // retry until unique within this browser storage
    let tries = 0;
    while(tries++ < 50){
      let id = toCase(formatByPattern(pattern.value));
      if(!issued.has(id)) return id;
    }
    // fallback add time suffix if extremely unlucky
    return toCase(formatByPattern(pattern.value)) + '-' + (Date.now()%1000).toString(36);
  };

  const setPreview = (id, ts = Date.now())=>{
    const d = new Date(ts);
    const bulanAbbr = ["Jan","Feb","Mar","Apr","Mei","Jun","Jul","Agu","Sep","Okt","Nov","Des"];
    const tgl = `${d.getDate()} ${bulanAbbr[d.getMonth()]} ${d.getFullYear()}`;
    const pfx = (prefix.value || 'No Pesanan: ');
    preview.textContent = `[${tgl}] ${pfx}${id}`;
  };

  const addHistory = (id)=>{
    const rec = { id, ts: Date.now(), seq: ++counter };
    history.push(rec);
    issued.add(id);
    save(LS_COUNTER,counter);
    save(LS_HISTORY,history);
    save(LS_ISSUED,Array.from(issued));
    refreshTable();
    setPreview(id, rec.ts);
    if(autocopy.value==='1') copyText(preview.textContent).then(ok=> showToast(ok ? 'Disalin otomatis' : 'Gagal menyalin. Klik Copy'));
  };

  const copyText = async (t)=>{
    try{
      if (navigator.clipboard && window.isSecureContext){
        await navigator.clipboard.writeText(t);
        return true;
      }
    }catch(e){}
    try{
      const ta = document.createElement('textarea');
      ta.value = t; ta.setAttribute('readonly','');
      ta.style.position='fixed'; ta.style.opacity='0';
      document.body.appendChild(ta);
      ta.focus(); ta.select(); ta.setSelectionRange(0, t.length);
      const ok = document.execCommand('copy');
      document.body.removeChild(ta);
      return ok;
    }catch(e){ return false; }
  };

  const hasId = ()=> preview.textContent && !preview.textContent.includes('—');

  btnGen.addEventListener('click', ()=> addHistory(uniqueId()));
  btnCopy.addEventListener('click', ()=> {
    if(!hasId()) return alert('Belum ada ID. Klik Generate.');
    copyText(preview.textContent).then(ok=>{
      btnCopy.textContent = ok ? 'Copied' : 'Copy';
      showToast(ok ? 'Tersalin' : 'Gagal menyalin');
      setTimeout(()=>btnCopy.textContent='Copy',1000);
    });
  });

  btnCsv.addEventListener('click', ()=>{
    const head = ['timestamp','waktu_locale','id','urutan'];
    const rows = history.map(r=>[r.ts,new Date(r.ts).toLocaleString(),r.id,r.seq]);
    const csv = [head].concat(rows).map(a=>a.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(',')).join('\n');
    const blob = new Blob([csv],{type:'text/csv;charset=utf-8'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href=url; a.download='riwayat_nomor_pesanan.csv'; a.click(); URL.revokeObjectURL(url);
  });

  btnReset.addEventListener('click', ()=>{
    if(confirm('Reset counter dan issued set?')){
      counter = 0; history = []; issued = new Set();
      save(LS_COUNTER,counter); save(LS_HISTORY,history); save(LS_ISSUED,[]);
      refreshTable(); setPreview('—');
    }
  });

  // akses cepat
  preview.addEventListener('dblclick', ()=> { if(hasId()) copyText(preview.textContent); });
  document.addEventListener('keydown', (e)=>{
    if(e.key==='Enter') addHistory(uniqueId());
    if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='s'){ e.preventDefault(); btnCsv.click(); }
    if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='c'){ if(hasId()) { e.preventDefault(); copyText(preview.textContent); } }
  });

  // initial state
  refreshTable();
  if(history.length){ const last = history[history.length-1]; setPreview(last.id, last.ts); }
  else { setPreview('—'); }
})();
</script>
</body>
</html>
